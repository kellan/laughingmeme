<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Getting started with Flickr real time APIs (in PHP) | Kellan Elliott-McCrea: Blog</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Getting started with Flickr real time APIs (in PHP)" />
<meta name="author" content="Kellan" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A personal blog of Kellan Elliott-McCrea. I don’t really know what a “laughing meme” is. It sounded cool in 1999." />
<meta property="og:description" content="A personal blog of Kellan Elliott-McCrea. I don’t really know what a “laughing meme” is. It sounded cool in 1999." />
<link rel="canonical" href="https://laughingmeme.org/2011/07/24/getting-started-with-flickr-real-time-apis-in-php/" />
<meta property="og:url" content="https://laughingmeme.org/2011/07/24/getting-started-with-flickr-real-time-apis-in-php/" />
<meta property="og:site_name" content="Kellan Elliott-McCrea: Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2011-07-24T06:47:05+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Getting started with Flickr real time APIs (in PHP)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Kellan"},"dateModified":"2011-07-24T06:47:05+00:00","datePublished":"2011-07-24T06:47:05+00:00","description":"A personal blog of Kellan Elliott-McCrea. I don’t really know what a “laughing meme” is. It sounded cool in 1999.","headline":"Getting started with Flickr real time APIs (in PHP)","mainEntityOfPage":{"@type":"WebPage","@id":"https://laughingmeme.org/2011/07/24/getting-started-with-flickr-real-time-apis-in-php/"},"url":"https://laughingmeme.org/2011/07/24/getting-started-with-flickr-real-time-apis-in-php/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://laughingmeme.org/feed.xml" title="Kellan Elliott-McCrea: Blog" /><style>
    .post-date {
      float: right;
    }
  </style>
  <script defer data-domain="laughingmeme.org" src="https://plausible.io/js/script.js"></script>

</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Kellan Elliott-McCrea: Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="https://kellanem.com/notes/">Leadership notes</a><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Getting started with Flickr real time APIs (in PHP)</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2011-07-24T06:47:05+00:00" itemprop="datePublished">Jul 24, 2011
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Kellan</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><a href="http://www.flickr.com/photos/kellan/5908292093/" title="MONOPILE DONUT FENDER by kellan, on Flickr"><img src="http://farm6.static.flickr.com/5273/5908292093_aec119eb54_z.jpg" alt="MONOPILE DONUT FENDER" /></a></p>

<p>Nils made public the <a href="http://code.flickr.com/blog/2011/06/30/dont-be-so-pushy/">Flickr PuSH (Pubsubhubbub) APIs</a> a few weeks back. And it being a lazy Sunday morning, I thought I finally get around to consuming them.</p>

<p>You can (and probably should) go read the <a href="http://code.google.com/p/pubsubhubbub/">Pubsubhubbub protocol</a>, but it’s written in standardese, and Flickr’s endpoints are a simpler degenerate case, so here’s the idea:</p>

<ul>
  <li>it’s <a href="http://www.webhooks.org/">web hooks</a></li>
  <li>get an authorized token from the Flickr API like you always do</li>
  <li>make a subscribe API call</li>
  <li>have an callback that can echo back the challenge code every 24 hours</li>
  <li>and Flickr will push you bits of Atom feeds in real time.</li>
</ul>

<h3 id="get-an-auth-token">Get an Auth Token</h3>

<p>We could use the <a href="http://code.flickr.com/blog/2011/06/21/flickr-now-supports-oauth-1-0a/">Flickr OAuth support</a>, but FlickrAuth is simpler to demonstrate.</p>

<p>You can do this step anyway you want, but I’d grab (https://github.com/kellan/flickr.simple.php), paste your <a href="http://www.flickr.com/services/api/keys/">key and secret</a> into <a href="https://github.com/kellan/flickr.simple.php/tree/master/scripts">scripts/auth.php</a>, and run it from the command line, at which point it will walk you thru an interactive prompt to get a token.</p>

<p>And just to state the obvious, you need a token because these feeds are personalized: photos or favorites from <strong>your</strong> contacts, photos of people you know, your photos, and your faves.</p>

<h3 id="an-endpoint">An Endpoint</h3>

<p>Your endpoint does double duty. It handles subscription requests, and processes pushes. Let’s write the subscription handler.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php
    # file: callback.php

    # handle subscription requests 

    if ($_REQUEST['challenge']) {
        if ($_REQUEST['verify_token'] == 'MY VERIFY TOKEN') {
            echo $_REQUEST['challenge'];
        }
    } else {
        echo "Ok";
    }

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">verify_token</code> is an arbitrary string you pass in that Flickr will pass back to you. Among other things it makes securing your subscription handler against XSS a bit more straightforward. (just don’t use “MY VERIFY TOKEN” ok?)</p>

<p>The <code class="language-plaintext highlighter-rouge">challenge</code> is a string that Flickr will generate and send to you to make sure you’re actually interested in having a bunch of photos pushed to you. You’re only responsibility in subscribing is to echo it back. This will happen when you first subscribe, and then again every time your subscription lease is up, which is by default once a day.</p>

<h3 id="subscribing-to-a-feed">Subscribing to a feed</h3>

<p>Is just a call to <a href="http://www.flickr.com/services/api/flickr.push.subscribe.html"><code class="language-plaintext highlighter-rouge">flickr.push.subscribe</code></a>. Here’s how to do that, using flickr.simple</p>

<p>include ‘flickr.simple.php’;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php
    # file: subscribe.php

    include 'flickr.simple.php';

    $key = 'your-key-from-step-1';
    $secret = 'your-secret-from-step-1';
    $token = 'your-token-from-step-1';

    $flickr = new Flickr($key, $secret);

    $rsp = $flickr-&gt;call_method('flickr.push.subscribe', array(
        'auth_token' =&gt; $token,
        'topic' =&gt; 'contacts_faves',
        'callback' =&gt; 'http://laughingmeme.org/code/monopiledonutfender.php',
        'verify' =&gt; 'async',
        'verify_token' =&gt; 'MY VERIFY TOKEN',
    ));

    var_dump($rsp);

</code></pre></div></div>

<p>Here we are subscribing to the favorites from your contacts stream. You can get a list of available streams with a call to <a href="http://www.flickr.com/services/api/flickr.push.getTopics.html"><code class="language-plaintext highlighter-rouge">flickr.push.getTopics</code></a>, which you could write a script to call, but I’d probably just call it in the <a href="http://www.flickr.com/services/api/explore/flickr.push.getTopics">API Explorer</a> and get the list:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;topics&gt;
    &lt;topic name="contacts_photos" /&gt;
    &lt;topic name="contacts_faves" /&gt;
    &lt;topic name="photos_of_contacts" /&gt;
    &lt;topic name="photos_of_me" /&gt;
    &lt;topic name="my_photos" /&gt;
    &lt;topic name="my_faves" /&gt;
&lt;/topics&gt;

</code></pre></div></div>

<p>Note: you’re going to need a different endpoint for each different topic. I just add <code class="language-plaintext highlighter-rouge">?contacts_photos=1</code> or <code class="language-plaintext highlighter-rouge">?photos_of_me=1</code> to my callback URLs to distinguish them.</p>

<h3 id="subscribing-putting-it-all-together">Subscribing: Putting it all together</h3>

<p>Upload <code class="language-plaintext highlighter-rouge">callback.php</code> somewhere publicly addressable, point the <code class="language-plaintext highlighter-rouge">callback</code> arg in subscribe to that URL, make sure your <code class="language-plaintext highlighter-rouge">verify_token</code> is the same in both scripts, and then run <code class="language-plaintext highlighter-rouge">subscribe.php</code></p>

<p>To check that it worked, get a list of your subscriptions with</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php

    include 'flickr.simple.php';

    $key = 'your-key';
    $secret = 'your-secret';
    $token = 'your-token';

    $flickr = new Flickr($key, $secret);

    $rsp = $flickr-&gt;call_method('flickr.push.getSubscriptions', array(
    'auth_token' =&gt; $token,
    ));

    var_dump($rsp);

</code></pre></div></div>

<p>If you see subscriptions that are still pending with non-zero verify attempts you did something wrong. Go have your morning coffee and try again. (&lt;== this worked for me, your mileage may vary)</p>

<h3 id="processing">Processing</h3>

<p>So assuming that all worked, Flickr is now bombarding your <code class="language-plaintext highlighter-rouge">callback.php</code> periodically with Atom blobs containing the information you requested. In practice I’m sticking the blobs into Redis in a list, and treating it as a queue to split processing from <code class="language-plaintext highlighter-rouge">callback.php</code> (this all runs on a tiny Linode VM and tying up Apache process is a bad idea), but for the sake of demonstration we can assume that if we weren’t passed a <code class="language-plaintext highlighter-rouge">challenge</code> then this is a payload and we’ll add the processing right to <code class="language-plaintext highlighter-rouge">callback.php</code>.</p>

<p>There are of course many ways to parse Atom (much like there are many ways to call the Flickr API), but unsurprisingly I’d use <a href="https://github.com/kellan/magpierss">Magpie</a>, and in particular I’d grab <a href="https://github.com/kellan/magpierss/blob/master/rss\_parse.inc"><code class="language-plaintext highlighter-rouge">rss_parse.inc</code></a>, which, while not having been touched in 7 years but still works.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php
    # file: callback.php

    # handle subscription requests 

    if ($_REQUEST['challenge']) {
        if ($_REQUEST['verify_token'] == 'MY VERIFY TOKEN') {
            echo $_REQUEST['challenge'];
        }
    } else {
        echo "Ok";
        require 'rss_parse.inc';
        $xml = file_get_contents("php://input");
        $feed = new MagpieRSS($xml, 'UTF-8', 'UTF-8');

        # do logic on feed here!

</code></pre></div></div>

<h3 id="the-interesting-bit">The interesting bit</h3>

<p>Of course the interesting bits all come after “do logic on feed here!”. This is where you build your feel newsfeed for Flickr, your replacement for photos from your contacts, your anteater. That bit is up to you. (though given an infinite supply of lazy Sunday mornings, maybe I’ll post a follow up)</p>

<h3 id="at-web-20-expo">At Web 2.0 Expo</h3>

<p>I’m really looking forward to seeing Nis talk about the architecture that supports these feeds this fall at Web 2.0 Expo NYC, <a href="http://www.web2expo.com/webexny2011/public/schedule/speaker/120329">Flickr PuSH: Real-time Updates on the Cheap for Fun and Profit</a></p>

  </div><a class="u-url" href="/2011/07/24/getting-started-with-flickr-real-time-apis-in-php/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">


    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Kellan Elliott-McCrea</li><li><a class="u-email" href="mailto:kellan@gmail.com">kellan@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list">
  <li>On Mastodon: <a href="https://fiasco.social/@kellan">@kellan</a></li><li><a href="https://www.twitter.com/kellan"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">kellan</span></a></li><li><a href="https://www.flickr.com/photos/kellan"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#flickr"></use></svg> <span class="username">kellan</span></a></li><li><a href="https://github.com/kellan"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">kellan</span></a></li><li><a href="https://www.linkedin.com/in/kellanem"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">kellanem</span></a></li><li><a href="https://kellanem.com/notes/">Leadership blog</a></li>
</ul>
</div>

      <div class="footer-col footer-col-3">
        <p>A personal blog of Kellan Elliott-McCrea. I don&#39;t really know what a &quot;laughing meme&quot; is. It sounded cool in 1999.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
